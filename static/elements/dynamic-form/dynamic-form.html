<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="dynamic-form">
    <template>
        <style>
            .buttons {
                padding-left: 36px;
            }

            .form-card {
                width: 100%;
                padding: 16px 36px 46px 36px;
                --paper-card-header-color: #2196F3;
                --paper-card-header: {
                    padding-left: 10px;
                };
                --paper-card-header-text: {
                    text-align: center;
                }

            }

            paper-button {
                padding: 5px;
                font-size: 16px;
                margin-top: 2%;
                margin-bottom: 5%;
                border-radius: 10%;
            }

            #toastResponse {
                position: absolute;
            }

            .dismiss {
                background-color: #D32F2F;
                color: #fff
            }

            .dismiss:hover {
                background-color: #F44336;
            }

            .acept {
                background-color: #689F38;
                color: #fff;

            }

            .acept:hover {
                background-color: #8BC34A;
            }

            .flexchild {
                @apply(--layout-flex);
            }
        </style>
        <paper-card heading="Reporte de necesidades" class="form-card">
            <div class="card-content"></div>
            <form is="iron-form"
                  id="reportForm"
                  method="post"
                  action="/por_definir/"
                  content-type="application/json"
                  disableNativeValidationUi>
            </form>
            <footer class="buttons horizontal layout end flexchild">
                <paper-toast id="toastResponse" duration="30000"></paper-toast>
                <paper-button id="dismiss" class="dismiss" on-click="_closeHandler">Cancelar</paper-button>
                <paper-button id="confirm" class="acept" on-click="_confirmHandler">Aceptar</paper-button>
            </footer>
        </paper-card>
    </template>
    <script>
        Polymer({
            is: "dynamic-form",

            properties: {
                metadata: Object,
                fields: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },
                fieldsMappingGenerators: {
                    type: Object,
                    value: function () {
                        return {
                            'TEXTO_SOLO_NUMEROS_ENTEROS': 'getTextInput',
                            'TEXTO_SOLO_DECIMALES': 'getTextInput',
                            'TEXTO_SOLO_LETRAS': 'getTextInput',
                            'TEXTO_SOLO_LETRAS_Y_NUMEROS': 'getTextInput',
                            'TEXTO_SOLO_LETRAS_CON_ESPACIOS': 'getTextInput',
                            'TEXTO_SOLO_LETRAS_Y_NUMEROS_CON_ESPACIOS': 'getTextInput',
                            'TEXTO_SOLO_LETRAS_Y_NUMEROS_CON_ESPACIOS_Y_SIMBOLOS': 'getTextInput',
                            'SELECCIONABLE_TEXTO': 'getSelectInput'
                        }
                    }
                },

                fieldsMappingTypes: {
                    type: Object,
                    value: function () {
                        return {
                            'TEXTO_SOLO_NUMEROS_ENTEROS': {
                                'widget': 'paper-input',
                                'allowedPattern': '^[0-9]*$',
                                'pattern': '',
                                'defaultError': 'Solo se permite el ingreso de números enteros'
                            },

                            'TEXTO_SOLO_DECIMALES': {
                                'widget': 'paper-input',
                                'allowedPattern': '^[0-9]+(\.[0-9]{1,2})?$',
                                'pattern': '',
                                'defaultError': 'Solo se permite el ingreso de numeros con dos decimales'

                            },

                            'TEXTO_SOLO_LETRAS': {
                                'widget': 'paper-input',
                                'allowedPattern': '^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ]*$',
                                'pattern': '',
                                'defaultError': 'Solo se permite el ingreso de letras'
                            },

                            'TEXTO_SOLO_LETRAS_Y_NUMEROS': {
                                'widget': 'paper-input',
                                'allowedPattern': '^[0-9a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]*$',
                                'pattern': '',
                                'defaultError': 'Solo se permite el ingreso de letras y numeros'
                            },
                            'TEXTO_SOLO_LETRAS_CON_ESPACIOS': {
                                'widget': 'paper-input',
                                'allowedPattern': '^[a-zA-Z áéíóúÁÉÍÓÚñÑüÜ\s]*$',
                                'pattern': '',
                                'defaultError': 'Solo se permite el ingreso de letras y espacios'
                            },
                            'TEXTO_SOLO_LETRAS_Y_NUMEROS_CON_ESPACIOS': {
                                'widget': 'paper-input',
                                'allowedPattern': '^[0-9a-zA-Z áéíóúÁÉÍÓÚñÑüÜ\s]*$',
                                'pattern': '',
                                'defaultError': 'Solo se permite el ingreso de letras, números y espacios'
                            },
                            'TEXTO_SOLO_LETRAS_Y_NUMEROS_CON_ESPACIOS_Y_SIMBOLOS': {
                                'widget': 'paper-input',
                                'allowedPattern': '^[a-zA-Z0-9 áéíóúÁÉÍÓÚñÑüÜ\%\$\#\@\!\?\¿\(\)\&\/\\\[\]\*\,\.\:\s]*$',
                                'pattern': '',
                                'defaultError': 'Solo se permite el ingreso de letras, numeros, espacios y símbolos'
                            },

                            'SELECCIONABLE_TEXTO': {
                                'widget': 'paper-dropdown-menu',
                                'defaultError': 'Seleccione una opción'
                            }
                        }
                    }
                },

                formMetadataService: Object
            },

            ready: function () {
                this.getFormMetadata();
            },

            getFormMetadata: function () {
                this.formMetadataService = document.createElement('iron-ajax');
                this.formMetadataService.url = '/api-forms/metadata/1?format=json';
                this.formMetadataService.handleAs = 'json';
                this.appendChild(this.formMetadataService);
                this.formMetadataService.addEventListener(
                        'response', this._setFormMetadata.bind(this));
                this.formMetadataService.generateRequest();
            },

            _setFormMetadata: function (event) {
                this.metadata = event.target.lastResponse;
                this.generateFormFields();
            },

            generateFormFields: function () {
                var fields = this.metadata['fields'];
                for (var i = 0; i < fields.length; i++) {
                    var field = fields[i];
                    var dom_field = this.getDomElementFromField(field);
                    var container = new elementContainer(dom_field, field['help_text']);
                    this.$$('#reportForm').appendChild(container);
                    this.fields.push(dom_field);
                }
            },

            getDomElementFromField: function (field) {
                var generator = this.fieldsMappingGenerators[field['type']];
                return this[generator](field);
            },

            getTextInput: function (field) {
                var fieldType = this.fieldsMappingTypes[field['type']];
                var text_input = document.createElement(fieldType['widget']);
                text_input.label = field['verbose_name'];
                text_input.required = field['required'];
                text_input.errorMessage = fieldType['defaultError'];
                text_input.placeholder = '     ';
                text_input.allowedPattern = fieldType['allowedPattern'];
                text_input.pattern = fieldType['pattern'];
                text_input.autoValidate = fieldType['allowedPattern'] != undefined;
                return text_input;
            },

            getSelectInput: function (field) {
                var fieldType = this.fieldsMappingTypes[field['type']];
                var select_input = new selectElement(field['choices'], field['verbose_name']);
                select_input.required = field['required'];
                select_input.errorMessage = fieldType['defaultError'];

                return select_input;
            },

            _confirmHandler: function () {
                (this.$.reportForm.validate()) ? this.showValue() : this.showError();
            },

            showValue: function () {
                this.$.toastResponse.text = 'Correcto';
                this.$.toastResponse.show();
            },

        })
    </script>
</dom-module>